---
title: "data_exploration"
author: "Lissy Denkers"
date: "01-04-2022"
output:
  pdf_document: default
  html_document: default
---

```{r setup, echo=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE, 
                      message = FALSE, 
                      fig.width = 8, 
                      fig.height = 5, 
                      fig.align = "center")
suppressPackageStartupMessages(library("ggplot2"))
suppressPackageStartupMessages(library("ggrepel"))
suppressPackageStartupMessages(library("patchwork"))
suppressPackageStartupMessages(library("ggpubr"))
suppressPackageStartupMessages(library("ggpubfigs"))
suppressPackageStartupMessages(library("lemon"))
suppressPackageStartupMessages(library("plyr"))
suppressPackageStartupMessages(library("dplyr"))
suppressPackageStartupMessages(library("skimr"))
suppressPackageStartupMessages(library("Hmisc"))
suppressPackageStartupMessages(library("tidyr"))
suppressPackageStartupMessages(library("car"))
suppressPackageStartupMessages(library("rstatix"))
suppressPackageStartupMessages(library("tidyverse"))
suppressPackageStartupMessages(library("broom"))
suppressPackageStartupMessages(library("drc"))
suppressPackageStartupMessages(library("modelr"))
suppressPackageStartupMessages(library("egg"))
suppressPackageStartupMessages(library("tidydrc"))
suppressPackageStartupMessages(library("aomisc"))
suppressPackageStartupMessages(library("devtools"))
```

# Data import 

## Background information

This is the data of the whitefly development bioassay on hydroponically grown S. lycopersicum MM. Control plants were grown on standard hydroponics solution, riboflavin treated plants were grown on hydroponics solution with riboflavin added in increasing concentrations over time. The highest concentration, added on day 13, was lethal for the plants. Data after this day should therefore be removed before analysis.
The raw data also contains the data of a simultaniously performed bioassay on S. chmielewskii. This data should be removed before analysis.
After the fourth instar stage, whiteflies develop into adults, leaving behind the larval skin called exuviae. Nymphs in the last phase of fourth instar stage and exuviae were removed from the leaf after each count to prevent a whitefly outbreak in the greenhouse.

See metadata file for more information.

## The raw data
```{r flies}
flies <- read.csv("raw_data.csv", 
                         header = T, 
                         sep = ",", 
                         dec = ".", 
                         check.names = FALSE)
```

```{r filter}
flies <- flies %>%
  dplyr::filter(genotype == "MM")  %>%
  dplyr::filter(day < 18)  %>%
  dplyr::filter(id != "MM_rib_4") 
# The first 10 rows of the data
knitr::kable(flies[1:10,1:8])

```

```{r palette}
palette <- c("#E69F00", "#D55E00", "#56B4E9", "#0072B2")
MM_palette <- c("#E69F00", "#D55E00") 
```

```{r functions}
cumul_median <- function(data, na.rm = FALSE) {
    for(i in 1:dim(data)[1]) {
    if(data$day[i] == 2) { data$var_new[i] <- data$var_new[i]  
    } else {
    if(na.rm==TRUE) {
    data$var_new[i] <- data$var_new[i] 
    } else {
      if(data$var_new[i] < data$var_new[i-1]) {
    data$var_new[i] <- data$var_new[i-1] 
      } else {
    data$var_new[i] <- data$var_new[i] 
    }
      } 
    }
    }   
    data$var_new
  } 
  
cumul_fun <- function(data) {
  rel_cumul = tibble()
 for(i in c("LA1840_1", "MM_2", "MM_3", "LA1840_5", "LA1840_6", "LA1840_7", "MM_8", "MM_9", "MM_10", "LA1840_11", "LA1840_12")){
   subdata = subset(data, id == i)
   subdata[[i]] = cumul_median(subdata)
   rel_cumul <- bind_rows(rel_cumul, subdata)
 }
  }
  
```

## Preparing the data for analysis

Next, a few improvements to the data should be made before analysis.

```{r wide}
flies <- flies %>%
  mutate(stage = as.factor(stage)) %>%
  pivot_wider(names_from = stage, values_from = number) 
```

Because the fourth instars are the end point and taken of after counting, combine fourth instars and exuviae and make their numbers cumulative over time. 
```{r total fourth instars}
flies <- flies %>%
  mutate(fourth_exuviae = `5_late_fourth_instar` + `6_exuviea`) %>%
  group_by(id) %>%
  mutate(`5_completed_lifecycle` = cumsum(fourth_exuviae)) %>%
  mutate(`4_fourth_instar` = `4_early_fourth_instar` + `5_completed_lifecycle`) %>%
  ungroup()
```

Remove separate and non-cumulative late fourth instar and exuviae columns.
```{r remove unnessesary columns}
flies <- flies %>%
  dplyr::select(-`4_early_fourth_instar`: -`5_completed_lifecycle`)
```



```{r cumulative data}
cumulative_flies <- flies 

cumulative_flies <- cumulative_flies %>%
  mutate(first_instars = rowSums(cumulative_flies[,8:11])) %>%
  mutate(second_instars = rowSums(cumulative_flies[,9:11])) %>%
  mutate(third_instars = rowSums(cumulative_flies[,10:11])) %>%
  mutate(fourth_instars = `4_fourth_instar`)
```


```{r correct}
cumulative_flies <- cumulative_flies %>%
  mutate(var_new = first_instars) %>%
  mutate(day = as.numeric(as.character(day))) %>%
  mutate(id = as.factor(id)) %>%
  group_by(id)


  rel_cumul = tibble()
 for(i in c("MM_c_1", "MM_c_2", "MM_c_3", "MM_c_4", "MM_c_5", "MM_rib_1", "MM_rib_2", "MM_rib_3", "MM_rib_5")){
   subdata = subset(cumulative_flies, id == i)
   if(anyNA(subdata$var_new)==TRUE) {
     subdata[i] = cumul_median(subdata, na.rm = TRUE)
   } else {
     subdata[i] = cumul_median(subdata)
   }
   rel_cumul <- bind_rows(rel_cumul, subdata)
 }


cumulative_flies <- rel_cumul %>%
  unite("first_instars", MM_c_1:MM_rib_5, 
                                  na.rm = TRUE)  %>%
  mutate(var_new = second_instars)

  rel_cumul = tibble()
 for(i in c("MM_c_1", "MM_c_2", "MM_c_3", "MM_c_4", "MM_c_5", "MM_rib_1", "MM_rib_2", "MM_rib_3", "MM_rib_5")){
   subdata = subset(cumulative_flies, id == i)
   if(anyNA(subdata$var_new)==TRUE) {
     subdata[i] = cumul_median(subdata, na.rm = TRUE)
   } else {
     subdata[i] = cumul_median(subdata)
   }
   rel_cumul <- bind_rows(rel_cumul, subdata)
 }


cumulative_flies <- rel_cumul %>%
  unite("second_instars", MM_c_1:MM_rib_5, 
                                  na.rm = TRUE)  %>%
  mutate(var_new = third_instars)



  rel_cumul = tibble()
 for(i in c("MM_c_1", "MM_c_2", "MM_c_3", "MM_c_4", "MM_c_5", "MM_rib_1", "MM_rib_2", "MM_rib_3", "MM_rib_5")){
   subdata = subset(cumulative_flies, id == i)
   if(anyNA(subdata$var_new)==TRUE) {
     subdata[i] = cumul_median(subdata, na.rm = TRUE)
   } else {
     subdata[i] = cumul_median(subdata)
   }
   rel_cumul <- bind_rows(rel_cumul, subdata)
 }


cumulative_flies <- rel_cumul %>%
  unite("third_instars", MM_c_1:MM_rib_5, 
                                  na.rm = TRUE)  %>%
  mutate(var_new = fourth_instars)



  rel_cumul = tibble()
 for(i in c("MM_c_1", "MM_c_2", "MM_c_3", "MM_c_4", "MM_c_5", "MM_rib_1", "MM_rib_2", "MM_rib_3", "MM_rib_5")){
   subdata = subset(cumulative_flies, id == i)
   if(anyNA(subdata$var_new)==TRUE) {
     subdata[i] = cumul_median(subdata, na.rm = TRUE)
   } else {
     subdata[i] = cumul_median(subdata)
   }
   rel_cumul <- bind_rows(rel_cumul, subdata)
 }


cumulative_flies <- rel_cumul %>%
  unite("fourth_instars", MM_c_1:MM_rib_5, 
                                  na.rm = TRUE)
cumulative_flies[cumulative_flies == ""]<-NA
```


```{r numeric}
cumulative_flies <- cumulative_flies %>%
  mutate(day = as.factor(day)) %>% 
  mutate(first_instars = as.numeric(as.character(first_instars))) %>% 
  mutate(second_instars = as.numeric(as.character(second_instars))) %>% 
  mutate(third_instars = as.numeric(as.character(third_instars)))  %>% 
  mutate(fourth_instars = as.numeric(as.character(fourth_instars))) 


cumulative_flies <- cumulative_flies %>%
  dplyr::select(-`0_egg`: -`4_fourth_instar`) 
```

```{r relative to eggs}
cumulative_flies <- cumulative_flies %>%
  group_by(id) %>%
  mutate(first = (first_instars / eggs_start)*100)%>%
  mutate(second = (second_instars / eggs_start)*100)%>%
  mutate(third = (third_instars / eggs_start)*100)%>%
  mutate(fourth = (fourth_instars / eggs_start)*100) %>%
  ungroup() 

cumulative_flies <- cumulative_flies %>%
  dplyr::select(-var_new)

cumulative_flies <- cumulative_flies %>%
  pivot_longer(cols = eggs_start:fourth, 
               names_to = "stage", values_to = "number") %>%
  mutate(treatment = factor(treatment, levels = c("control", "riboflavin"))) %>%
  mutate(stage = factor(stage, levels = c("eggs_start", "first_instars", "second_instars", "third_instars", "fourth_instars", 
                                          "first", "second", "third", "fourth"))) 
```


```{r combined plot, fig.width = 16, fig.height = 10}

#egg and hatching
p_eggs <- cumulative_flies %>% 
  dplyr::filter(day == 2) %>%
  dplyr::filter(stage == "eggs_start") %>%
  ggplot(aes(x=treatment, y=number, fill=treatment)) + 
  labs(y = "eggs (count)") +
  geom_boxplot() + 
  ylim(0,120) +
  theme_simple() + 
  scale_fill_manual(values = MM_palette) +
  stat_compare_means(method = "t.test")

p_first <- cumulative_flies %>% 
  dplyr::filter(day == 13) %>%
  dplyr::filter(stage == "first_instars") %>%
  ggplot(aes(x=treatment, y=number, fill=treatment)) + 
  labs(y = "hatched eggs (count)") +
  geom_boxplot() + 
  ylim(0,120) +
  theme_simple() + 
  scale_fill_manual(values = MM_palette)  +
  stat_compare_means(method = "t.test")

p_second <- cumulative_flies %>% 
  dplyr::filter(day == 13) %>%
  dplyr::filter(stage == "second_instars") %>%
  ggplot(aes(x=treatment, y=number, fill=treatment)) + 
  labs(y = "2nd instar nymphs (count)") +
  geom_boxplot() + 
  ylim(0,120) +
  theme_simple() + 
  scale_fill_manual(values = MM_palette) +
  stat_compare_means(method = "t.test") 

p_third <- cumulative_flies %>% 
  dplyr::filter(day == 13) %>%
  dplyr::filter(stage == "third_instars") %>%
  ggplot(aes(x=treatment, y=number, fill=treatment)) + 
  labs(y = "3rd instar nymphs (count)") +
  geom_boxplot() + 
  ylim(0,120) +
  theme_simple() + 
  scale_fill_manual(values = MM_palette) +
  stat_compare_means(method = "t.test") 

p_1 <- cumulative_flies %>% 
  dplyr::filter(day == 13) %>%
  dplyr::filter(stage == "first") %>%
  ggplot(aes(x=treatment, y=number, fill=treatment)) + 
  labs(y = "hatched eggs (%)") +
  geom_boxplot() + 
  ylim(0,100) +
  theme_simple() + 
  scale_fill_manual(values = MM_palette)  +
  stat_compare_means(method = "t.test")

# development %
p_2 <- cumulative_flies %>% 
  dplyr::filter(day == 13) %>%
  dplyr::filter(stage == "second") %>%
  ggplot(aes(x=treatment, y=number, fill=treatment)) + 
  labs(y = "development egg to 2nd instar (%)") +
  geom_boxplot() + 
  ylim(0,100) +
  theme_simple() + 
  scale_fill_manual(values = MM_palette)  +
  stat_compare_means(method = "t.test")

p_3 <- cumulative_flies %>% 
  dplyr::filter(day == 13) %>%
  dplyr::filter(stage == "third") %>%
  ggplot(aes(x=treatment, y=number, fill=treatment)) + 
  labs(y = "development egg to 3rd instar (%)") +
  geom_boxplot() + 
  ylim(0,100) +
  theme_simple() + 
  scale_fill_manual(values = MM_palette)  +
  stat_compare_means(method = "t.test")

p_4 <- cumulative_flies %>% 
  dplyr::filter(day == 13) %>%
  dplyr::filter(stage == "fourth") %>%
  ggplot(aes(x=treatment, y=number, fill=treatment)) + 
  labs(y = "development egg to 4th instar (%)") +
  geom_boxplot() + 
  ylim(0,100) +
  theme_simple() + 
  scale_fill_manual(values = MM_palette) +
  stat_compare_means(method = "t.test")

collected <- ((p_eggs | p_first | p_second | p_third)  / (p_1 | p_2 | p_3))  / guide_area() +
  plot_layout(guides = 'collect') +
  plot_annotation(tag_levels = 'a')

collected

#(p_MM| p_LA1840) / (p_2 | p_3 | p_4)) / (p_M | p_L)) /

#ggsave(filename = "inhibitor_bioassay_boxplots.png", plot = collected, width = 10, height = 15)
```



```{r median and IQR}
relative_cumulative <- cumulative_flies %>%
  dplyr::filter(stage == "first" | stage == "second" | stage == "third" | stage == "fourth")

relative_cumulative <- relative_cumulative %>%
  mutate(treatment = factor(treatment, levels = c("control", "riboflavin"))) 

relative_cumulative <- relative_cumulative %>%
  mutate(stage = as.factor(stage)) %>%
  mutate(id = as.factor(id)) %>%
  group_by(stage, treatment) %>%
  pivot_wider(names_from = id, values_from = number)

relative_cumulative <- relative_cumulative %>%
  mutate(day = as.factor(day)) %>%
  rowwise() %>%
  mutate(median_abundance = median(
    c_across(MM_c_1:MM_rib_5), na.rm = TRUE)) %>%
  mutate(max_abundance = max(
    c_across(MM_c_1:MM_rib_5), na.rm = TRUE)) %>%
  mutate(min_abundance = min(
    c_across(MM_c_1:MM_rib_5), na.rm = TRUE)) %>%
  mutate(IQR_abundance = IQR(
    c_across(MM_c_1:MM_rib_5), na.rm = TRUE)) %>%
  mutate(ymin_ribbon = (median_abundance - IQR_abundance)) %>%
  mutate(ymin_ribbon = if_else(ymin_ribbon < 0, 0, ymin_ribbon)) %>%
  mutate(day = as.numeric(as.character(day))) %>%
  dplyr::select(-MM_c_1:-MM_rib_5) 

relative_cumulative <- relative_cumulative %>%
  mutate(ymin_ribbon = (median_abundance - (0.5*IQR_abundance))) %>%
  mutate(ymin_ribbon = if_else(ymin_ribbon < 0, 0, ymin_ribbon)) %>%
  mutate(min_whisker = (median_abundance - (1.5*IQR_abundance))) %>%
  mutate(min_abundance = if_else(min_abundance < min_whisker, 
                                 min_whisker, min_abundance)) %>%
  mutate(max_whisker = (median_abundance + (1.5*IQR_abundance))) %>%
  mutate(max_abundance = if_else(max_abundance > max_whisker, 
                                 max_whisker, max_abundance))
```


```{r relative cumulative graph, fig.width = 16, fig.height = 10}
cumulative_flies <- cumulative_flies %>% mutate(day = as.numeric(as.character(day)))

p_second <- relative_cumulative %>%
  mutate(stage = factor(stage, 
                        levels = c("first", "second", "third", "fourth"))) %>%
  mutate(day = as.numeric(as.character(day))) %>% 
  dplyr::filter(stage == "second") %>% 
#  dplyr::filter(day > 9) %>% 
  group_by(treatment, stage) %>% 
  ggplot() +
  theme_simple() +
  labs(y = "development to second instar stage (%)",
       x = "days after infection") +
  scale_color_manual(values = MM_palette) +
  scale_fill_manual(values = MM_palette) +
#  geom_line(aes(x = day,
#                  y = min_abundance,
#                  color = genotype),
#              linetype = "dotted") +
#  geom_line(aes(x = day,
#                  y = max_abundance,
#                  color = genotype),
#              linetype = "dotted") +
  geom_ribbon(aes(x = day,
                  ymin = ymin_ribbon,
                  ymax = (median_abundance + (0.5*IQR_abundance)),
                  fill = treatment),
              alpha = 0.35) +
  geom_line(aes(x = day,
                y = median_abundance,
                color = treatment),
            size = 1) +
    stat_compare_means(data = cumulative_flies %>% dplyr::filter(stage == "second"), aes(x = day, 
               y = number, 
               group = treatment), 
               label.y = 65, label = "p.signif", method = "t.test") +
#  facet_rep_wrap(vars(stage), nrow = 1) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 100)) 
#  theme(panel.spacing = unit(0.1, "lines"))

p_third <- relative_cumulative %>%
  mutate(stage = factor(stage, 
                        levels = c("first", "second", "third", "fourth"))) %>%
  mutate(day = as.numeric(as.character(day))) %>% 
  dplyr::filter(stage == "third") %>% 
#  dplyr::filter(day > 9) %>% 
  group_by(treatment, stage) %>% 
  ggplot() +
  theme_simple() +
  labs(y = "development to third instar stage (%)",
       x = "days after infection") +
  scale_color_manual(values = MM_palette) +
  scale_fill_manual(values = MM_palette) +
#  geom_line(aes(x = day,
#                  y = min_abundance,
#                  color = genotype),
#              linetype = "dotted") +
#  geom_line(aes(x = day,
#                  y = max_abundance,
#                  color = genotype),
#              linetype = "dotted") +
  geom_ribbon(aes(x = day,
                  ymin = ymin_ribbon,
                  ymax = (median_abundance + (0.5*IQR_abundance)),
                  fill = treatment),
              alpha = 0.35) +
  geom_line(aes(x = day,
                y = median_abundance,
                color = treatment),
            size = 1) +
    stat_compare_means(data = cumulative_flies %>% dplyr::filter(stage == "third"), aes(x = day, 
              y = number, 
              group = treatment), 
              label.y = 65, label = "p.signif", method = "t.test") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 100)) 

p_fourth <- relative_cumulative %>%
  mutate(stage = factor(stage, 
                        levels = c("first", "second", "third", "fourth"))) %>%
  mutate(day = as.numeric(as.character(day))) %>% 
  dplyr::filter(stage == "fourth") %>% 
#  dplyr::filter(day > 9) %>% 
  group_by(treatment, stage) %>% 
  ggplot() +
  theme_simple() +
  labs(y = "development to instar stage (%)",
       x = "days after infection") +
  scale_color_manual(values = LA_palette) +
  scale_fill_manual(values = LA_palette) +
#  geom_line(aes(x = day,
#                  y = min_abundance,
#                  color = genotype),
#              linetype = "dotted") +
#  geom_line(aes(x = day,
#                  y = max_abundance,
#                  color = genotype),
#              linetype = "dotted") +
  geom_ribbon(aes(x = day,
                  ymin = ymin_ribbon,
                  ymax = (median_abundance + (0.5*IQR_abundance)),
                  fill = treatment),
              alpha = 0.35) +
  geom_line(aes(x = day,
                y = median_abundance,
                color = treatment),
            size = 1) +
    stat_compare_means(data = cumulative_flies %>% dplyr::filter(stage == "fourth"), aes(x = day,
               y = number, 
               group = treatment), 
               label.y = 65, label = "p.signif", method = "t.test") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 100))

p_cumulative <- (p_second | p_third) /  guide_area() +
  plot_layout(guides = 'collect') +
  plot_annotation(tag_levels = 'a')

p_cumulative 

ggsave(filename = "hydroponics_bioassay_lineplots_1.png", plot = p_cumulative, width = 10, height = 5)
```
The development to 2nd and 3rd instars is sygnificantly increased on the inhibitor treatedplants, but not to 4th instar. From the shape of the graph it is clear that the maximum of nymphs developing to 4th instar stage was not yet reached. I will try to correct for this by calculating the hypothetical maximum number still to develop to each instar stage (nymphs in instar stage at day 22 + nymphs of earlier stages still alive at day 22).

# use all living nymphs at last count to calculate possible future maximum

```{r still to become 4th instar}
test_flies <- flies %>%
  mutate(future_first = 0) %>%
  mutate(future_second = 0) %>%
  mutate(future_third = 0) %>%
  mutate(future_fourth = rowSums(flies[,8:11]))

test_flies <- test_flies %>%
  mutate(`1_first_instar` = future_first) %>%
  mutate(`2_second_instar` = future_second) %>%
  mutate(`3_third_instar` = future_third) %>%
  mutate(`4_fourth_instar` = future_fourth) %>%
  dplyr::select(-future_first:-future_fourth) %>% 
  dplyr::filter(day == 22) %>%
  mutate(day = 25) %>%
  mutate(date = 'future max.')

cumulative_flies <- bind_rows(flies, test_flies)
```

```{r hypothetical cumulative data}

cumulative_flies <- cumulative_flies %>%
  mutate(first_instars = rowSums(cumulative_flies[,8:11])) %>%
  mutate(second_instars = rowSums(cumulative_flies[,9:11])) %>%
  mutate(third_instars = rowSums(cumulative_flies[,10:11])) %>%
  mutate(fourth_instars = `4_fourth_instar`)
```


```{r hypothetical correct}
cumulative_flies <- cumulative_flies %>%
  mutate(var_new = first_instars) %>%
  mutate(day = as.numeric(as.character(day))) %>%
  mutate(id = as.factor(id)) %>%
  group_by(id)


  rel_cumul = tibble()
 for(i in c("LA1840_c_1", "LA1840_c_2", "LA1840_c_3", "LA1840_c_4", "LA1840_c_5", "LA1840_in_1", "LA1840_in_2", "LA1840_in_3", "LA1840_in_4", "LA1840_in_5")){
   subdata = subset(cumulative_flies, id == i)
   subdata[i] = cumul_median(subdata)
   rel_cumul <- bind_rows(rel_cumul, subdata)
 }


cumulative_flies <- rel_cumul %>%
  unite("first_instars", LA1840_c_1:LA1840_in_5, 
                                  na.rm = TRUE)  %>%
  mutate(var_new = second_instars)

  rel_cumul = tibble()
 for(i in c("LA1840_c_1", "LA1840_c_2", "LA1840_c_3", "LA1840_c_4", "LA1840_c_5", "LA1840_in_1", "LA1840_in_2", "LA1840_in_3", "LA1840_in_4", "LA1840_in_5")){
   subdata = subset(cumulative_flies, id == i)
   subdata[i] = cumul_median(subdata)
   rel_cumul <- bind_rows(rel_cumul, subdata)
 }


cumulative_flies <- rel_cumul %>%
  unite("second_instars", LA1840_c_1:LA1840_in_5, 
                                  na.rm = TRUE)  %>%
  mutate(var_new = third_instars)



  rel_cumul = tibble()
 for(i in c("LA1840_c_1", "LA1840_c_2", "LA1840_c_3", "LA1840_c_4", "LA1840_c_5", "LA1840_in_1", "LA1840_in_2", "LA1840_in_3", "LA1840_in_4", "LA1840_in_5")){
   subdata = subset(cumulative_flies, id == i)
   subdata[i] = cumul_median(subdata)
   rel_cumul <- bind_rows(rel_cumul, subdata)
 }


cumulative_flies <- rel_cumul %>%
  unite("third_instars", LA1840_c_1:LA1840_in_5, 
                                  na.rm = TRUE)  %>%
  mutate(var_new = fourth_instars)

  rel_cumul = tibble()
 for(i in c("LA1840_c_1", "LA1840_c_2", "LA1840_c_3", "LA1840_c_4", "LA1840_c_5", "LA1840_in_1", "LA1840_in_2", "LA1840_in_3", "LA1840_in_4", "LA1840_in_5")){
   subdata = subset(cumulative_flies, id == i)
   subdata[i] = cumul_median(subdata)
   rel_cumul <- bind_rows(rel_cumul, subdata)
 }


cumulative_flies <- rel_cumul %>%
  unite("fourth_instars", LA1840_c_1:LA1840_in_5, 
                                  na.rm = TRUE) 
```


```{r hypothetical numeric}
cumulative_flies <- cumulative_flies %>%
  mutate(day = as.factor(day)) %>% 
  mutate(first_instars = as.numeric(as.character(first_instars))) %>% 
  mutate(second_instars = as.numeric(as.character(second_instars))) %>% 
  mutate(third_instars = as.numeric(as.character(third_instars))) %>% 
  mutate(fourth_instars = as.numeric(as.character(fourth_instars)))  


cumulative_flies <- cumulative_flies %>%
  dplyr::select(-`0_egg`: -`4_fourth_instar`) 
```

```{r hypothetical relative to eggs}
cumulative_flies <- cumulative_flies %>%
  group_by(id) %>%
  mutate(first = (first_instars / eggs_start)*100)%>%
  mutate(second = (second_instars / eggs_start)*100)%>%
  mutate(third = (third_instars / eggs_start)*100)%>%
  mutate(fourth = (fourth_instars / eggs_start)*100) %>%
  ungroup() 

cumulative_flies <- cumulative_flies %>%
  dplyr::select(-var_new)

cumulative_flies <- cumulative_flies %>%
  pivot_longer(cols = eggs_start:fourth, 
               names_to = "stage", values_to = "number") %>%
  mutate(treatment = factor(treatment, levels = c("control", "inhibitor"))) %>%
  mutate(stage = factor(stage, levels = c("eggs_start", "first_instars", "second_instars", "third_instars", "fourth_instars", 
                                          "first", "second", "third", "fourth"))) 
```


```{r hypothetical combined plot, fig.width = 16, fig.height = 10}

#egg and hatching
p_eggs <- cumulative_flies %>% 
  dplyr::filter(day == 2) %>%
  dplyr::filter(stage == "eggs_start") %>%
  ggplot(aes(x=treatment, y=number, fill=treatment)) + 
  labs(y = "eggs (count)") +
  geom_boxplot() + 
  ylim(0,150) +
  theme_simple() + 
  scale_fill_manual(values = LA_palette) +
  stat_compare_means(method = "t.test")

p_first <- cumulative_flies %>% 
  dplyr::filter(day == 25) %>%
  dplyr::filter(stage == "first_instars") %>%
  ggplot(aes(x=treatment, y=number, fill=treatment)) + 
  labs(y = "hatched eggs (count)") +
  geom_boxplot() + 
  ylim(0,150) +
  theme_simple() + 
  scale_fill_manual(values = LA_palette) 

p_fourth <- cumulative_flies %>% 
  dplyr::filter(day == 25) %>%
  dplyr::filter(stage == "fourth_instars") %>%
  ggplot(aes(x=treatment, y=number, fill=treatment)) + 
  labs(y = "hypothetical maximum 4th instar nymphs (count)") +
  geom_boxplot() + 
  ylim(0,150) +
  theme_simple() + 
  scale_fill_manual(values = LA_palette) +
  stat_compare_means(method = "t.test") 

p1 <- cumulative_flies %>% 
  dplyr::filter(day == 25) %>%
  dplyr::filter(stage == "first") %>%
  ggplot(aes(x=treatment, y=number, fill=treatment)) + 
  labs(y = "hatched eggs (%)") +
  geom_boxplot() + 
  ylim(0,70) +
  theme_simple() + 
  scale_fill_manual(values = LA_palette) 

# development %
p_2 <- cumulative_flies %>% 
  dplyr::filter(day == 25) %>%
  dplyr::filter(stage == "second") %>%
  ggplot(aes(x=treatment, y=number, fill=treatment)) + 
  labs(y = "development to second instar stage (%)") +
  geom_boxplot() + 
  ylim(0,70) +
  theme_simple() + 
  scale_fill_manual(values = LA_palette) 

p_3 <- cumulative_flies %>% 
  dplyr::filter(day == 25) %>%
  dplyr::filter(stage == "third") %>%
  ggplot(aes(x=treatment, y=number, fill=treatment)) + 
  labs(y = "development to third instar stage (%)") +
  geom_boxplot() + 
  ylim(0,70) +
  theme_simple() + 
  scale_fill_manual(values = LA_palette) 

p_4 <- cumulative_flies %>% 
  dplyr::filter(day == 25) %>%
  dplyr::filter(stage == "fourth") %>%
  ggplot(aes(x=treatment, y=number, fill=treatment)) + 
  labs(y = "hypothetical maximum development egg to 4th instar (%)") +
  geom_boxplot() + 
  ylim(0,70) +
  theme_simple() + 
  scale_fill_manual(values = LA_palette) +
  stat_compare_means(method = "t.test")

collected <- (p_eggs | p_fourth| p_4)  /  guide_area() +
  plot_layout(guides = 'collect') +
  plot_annotation(tag_levels = 'a')

collected

#(p_MM| p_LA1840) / (p_2 | p_3 | p_4)) / (p_M | p_L)) /

ggsave(filename = "inhibitor_bioassay_boxplots_2.png", plot = collected, width = 10, height = 15)
```



```{r hypothetical median and IQR}
relative_cumulative <- cumulative_flies %>%
  dplyr::filter(stage == "first" | stage == "second" | stage == "third" | stage == "fourth")

relative_cumulative <- relative_cumulative %>%
  mutate(treatment = factor(treatment, levels = c("control", "inhibitor"))) 

relative_cumulative <- relative_cumulative %>%
  mutate(stage = as.factor(stage)) %>%
  mutate(id = as.factor(id)) %>%
  group_by(stage, treatment) %>%
  pivot_wider(names_from = id, values_from = number)

relative_cumulative <- relative_cumulative %>%
  mutate(day = as.factor(day)) %>%
  rowwise() %>%
  mutate(median_abundance = median(
    c_across(LA1840_c_1:LA1840_in_5), na.rm = TRUE)) %>%
  mutate(max_abundance = max(
    c_across(LA1840_c_1:LA1840_in_5), na.rm = TRUE)) %>%
  mutate(min_abundance = min(
    c_across(LA1840_c_1:LA1840_in_5), na.rm = TRUE)) %>%
  mutate(IQR_abundance = IQR(
    c_across(LA1840_c_1:LA1840_in_5), na.rm = TRUE)) %>%
  mutate(ymin_ribbon = (median_abundance - IQR_abundance)) %>%
  mutate(ymin_ribbon = if_else(ymin_ribbon < 0, 0, ymin_ribbon)) %>%
  mutate(day = as.numeric(as.character(day))) %>%
  dplyr::select(-LA1840_c_1:-LA1840_in_5) 

relative_cumulative <- relative_cumulative %>%
  mutate(ymin_ribbon = (median_abundance - (0.5*IQR_abundance))) %>%
  mutate(ymin_ribbon = if_else(ymin_ribbon < 0, 0, ymin_ribbon)) %>%
  mutate(min_whisker = (median_abundance - (1.5*IQR_abundance))) %>%
  mutate(min_abundance = if_else(min_abundance < min_whisker, 
                                 min_whisker, min_abundance)) %>%
  mutate(max_whisker = (median_abundance + (1.5*IQR_abundance))) %>%
  mutate(max_abundance = if_else(max_abundance > max_whisker, 
                                 max_whisker, max_abundance))
```


```{r hypothetical relative cumulative graph, fig.width = 16, fig.height = 10}
cumulative_flies <- cumulative_flies %>% mutate(day = as.numeric(as.character(day)))

p_second <- relative_cumulative %>%
  mutate(stage = factor(stage, 
                        levels = c("first", "second", "third", "fourth"))) %>%
  mutate(day = as.numeric(as.character(day))) %>% 
  dplyr::filter(stage == "second") %>% 
#  dplyr::filter(day > 9) %>% 
  group_by(treatment, stage) %>% 
  ggplot() +
  theme_simple() +
  labs(y = "development to 2nd instar (%)",
       x = "days after infection") +
  scale_color_manual(values = LA_palette) +
  scale_fill_manual(values = LA_palette) +
  geom_vline(xintercept = 23,
              linetype = "dotted") +
  geom_ribbon(aes(x = day,
                  ymin = ymin_ribbon,
                  ymax = (median_abundance + (0.5*IQR_abundance)),
                  fill = treatment),
              alpha = 0.35) +
  geom_line(aes(x = day,
                y = median_abundance,
                color = treatment),
            size = 1) +
    stat_compare_means(data = cumulative_flies %>% dplyr::filter(stage == "second"), aes(x = day, 
               y = number, 
               group = treatment), 
               label.y = 65, label = "p.signif", method = "t.test") +
#  facet_rep_wrap(vars(stage), nrow = 1) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 70)) 
#  theme(panel.spacing = unit(0.1, "lines"))

p_third <- relative_cumulative %>%
  mutate(stage = factor(stage, 
                        levels = c("first", "second", "third", "fourth"))) %>%
  mutate(day = as.numeric(as.character(day))) %>% 
  dplyr::filter(stage == "third") %>% 
#  dplyr::filter(day > 9) %>% 
  group_by(treatment, stage) %>% 
  ggplot() +
  theme_simple() +
  labs(y = "development to 3rd instar (%)",
       x = "days after infection") +
  scale_color_manual(values = LA_palette) +
  scale_fill_manual(values = LA_palette) +
  geom_vline(xintercept = 23,
              linetype = "dotted") +
  geom_ribbon(aes(x = day,
                  ymin = ymin_ribbon,
                  ymax = (median_abundance + (0.5*IQR_abundance)),
                  fill = treatment),
              alpha = 0.35) +
  geom_line(aes(x = day,
                y = median_abundance,
                color = treatment),
            size = 1) +
    stat_compare_means(data = cumulative_flies %>% dplyr::filter(stage == "third"), aes(x = day, 
              y = number, 
              group = treatment), 
              label.y = 65, label = "p.signif", method = "t.test") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 70)) 

p_fourth <- relative_cumulative %>%
  mutate(stage = factor(stage, 
                        levels = c("first", "second", "third", "fourth"))) %>%
  mutate(day = as.numeric(as.character(day))) %>% 
  dplyr::filter(stage == "fourth") %>% 
#  dplyr::filter(day > 9) %>% 
  group_by(treatment, stage) %>% 
  ggplot() +
  theme_simple() +
  labs(y = "development to 4th instar (%)",
       x = "days after infection") +
  scale_color_manual(values = LA_palette) +
  scale_fill_manual(values = LA_palette) +
  geom_vline(xintercept = 23,
              linetype = "dotted") +
  geom_ribbon(aes(x = day,
                  ymin = ymin_ribbon,
                  ymax = (median_abundance + (0.5*IQR_abundance)),
                  fill = treatment),
              alpha = 0.35) +
  geom_line(aes(x = day,
                y = median_abundance,
                color = treatment),
            size = 1) +
    stat_compare_means(data = cumulative_flies %>% dplyr::filter(stage == "fourth"), aes(x = day,
               y = number, 
               group = treatment), 
               label.y = 65, label = "p.signif", method = "t.test") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 70))

p_cumulative <- (p_second | p_third | p_fourth) /  guide_area() +
  plot_layout(guides = 'collect') +
  plot_annotation(tag_levels = 'a')

p_cumulative 

ggsave(filename = "inhibitor_bioassay_lineplots_2.png", plot = p_cumulative, width = 10, height = 5)
```

The dashed line represents the end of the bioassay. Numbers at day 25 are the hypothetical maximum number of nymphs that could have developed to each stage.

The hypothetical maximum development to 4th instar nymphs is higher on inhibitor treated plants than on control plants.