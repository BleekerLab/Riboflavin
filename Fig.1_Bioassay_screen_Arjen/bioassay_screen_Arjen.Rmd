---
title: "Bioassay screen of Arjen"
author: "Lissy Denkers"
date: "`r Sys.Date()`"
output: 
  pdf_document: default
  html_document: default
---

```{r setup, echo=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE, 
                      message = FALSE, 
                      fig.width = 8, 
                      fig.height = 5, 
                      fig.align = "center")
suppressPackageStartupMessages(library("ggplot2"))
suppressPackageStartupMessages(library("ggpubr"))
suppressPackageStartupMessages(library("ggpubfigs"))
suppressPackageStartupMessages(library("patchwork"))
suppressPackageStartupMessages(library("multcomp"))
suppressPackageStartupMessages(library("car"))
suppressPackageStartupMessages(library("tidyverse"))
suppressPackageStartupMessages(library("rstatix"))
suppressPackageStartupMessages(library("broom"))
```

# Data import 

## Background information

This is the data of the whitefly development bioassay performed by Arjen van Doorn. Only MM and LA1840 will be used.

## The raw data
```{r flies}
flies <- read.csv("hertelling.csv", 
                         header = T, 
                         sep = ",", 
                         dec = ".", 
                         check.names = FALSE)%>%     
  dplyr::filter(genotype == "Moneymaker" | genotype == "LA1840") %>%
  mutate_if(is.character, str_replace_all, 
            pattern = "Moneymaker", replacement = "MM") %>%
  mutate(genotype = factor(genotype, levels = c("MM", "LA1840"))) 
# The first 10 rows of the data
knitr::kable(flies[1:10,1:4])
```

# plots

I'm doubting whether I should use the absolute or relative number of 4th instars for the plot, so I will try both.

## plot with absolute numbers

```{r absolute plot}
palette <- c("#E69F00", "#56B4E9", "#009E73",
          "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

flies %>%
  ggplot(aes(x=genotype, y=number, fill=genotype)) + 
  labs(y = "# of individuals") +
  geom_boxplot() + 
  scale_fill_manual(values = palette) +
  geom_point(aes(fill = genotype), size = 1, shape = 21,
             position = position_jitterdodge(jitter.width = 0.1)) +
  theme_simple() +
  facet_wrap(~ stage)

```


## plot with relative 4th instar numbers

```{r relative plot}
plot1 <- flies %>% 
  pivot_wider(names_from = stage, values_from = number) %>%
  mutate(percentage_from_eggs = fourth_instar / egg * 100) %>%
  pivot_longer(cols = fourth_instar:percentage_from_eggs, 
               names_to = "stage", values_to = "number") %>%
  dplyr::filter(stage == "percentage_from_eggs") %>%
  ggplot(aes(x=genotype, y=number, fill=genotype)) + 
  labs(y = "development to 4th instar (%)") +
  geom_boxplot() + 
  geom_point(aes(fill = genotype), size = 2, shape = 21,
             position = position_jitterdodge(jitter.width = 0.1)) +
  theme_big_simple() + 
  scale_fill_manual(values = palette)  +
  stat_compare_means(method = "wilcox.test", 
                     label.y = 45,
                     label.x.npc = 0.15,
                     size = 6)

plot_1 <- plot1  + guide_area() +
  plot_layout(guides = 'collect', widths = c(3,1))

# ggsave(filename = "boxplot_egg_to_4th.svg", plot = plot_1, width = 12, height = 10)
```

## combined
It might be best to use both for the most complete view of the phnotype.
```{r combined plot, fig.width = 16, fig.height = 10}
p1 <- flies %>% 
  dplyr::filter(stage == "egg") %>%
  dplyr::filter(replicate != 5) %>%
  ggplot(aes(x=genotype, y=number, fill=genotype)) + 
  labs(y = "eggs (count)") + 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 65)) +
  geom_boxplot() + 
  geom_point(aes(fill = genotype), size = 2, shape = 21,
             position = position_jitterdodge(jitter.width = 0.4)) + 
  theme_simple() + 
  scale_fill_manual(values = palette)  +
  stat_compare_means(method = "wilcox.test", 
                     label.y = 62,
                     label.x = 1.5,
                     size = 5,
                     label = "p.format") 

p2 <- flies %>% 
  dplyr::filter(stage == "fourth_instar") %>%
  ggplot(aes(x=genotype, y=number, fill=genotype)) + 
  labs(y = "4th instar nymphs (count)") +
  geom_boxplot() +  
  geom_point(aes(fill = genotype), size = 2, shape = 21,
             position = position_jitterdodge(jitter.width = 0.4)) + 
  theme_simple() +  
  scale_y_continuous(expand = c(0, 0), limits = c(0, 12)) +
  scale_fill_manual(values = palette)   +
  stat_compare_means(method = "wilcox.test", 
                     label.y = 11.5,
                     label.x = 1.5,
                     size = 5,
                     label = "p.format") 

p3 <- flies %>% 
  pivot_wider(names_from = stage, values_from = number) %>%
  mutate(percentage_from_eggs = fourth_instar / egg * 100) %>%
  pivot_longer(cols = fourth_instar:percentage_from_eggs, 
               names_to = "stage", values_to = "number") %>%
  dplyr::filter(stage == "percentage_from_eggs") %>%
  ggplot(aes(x=genotype, y=number, fill=genotype)) + 
  labs(y = "development egg to 4th instar (%)") +
  geom_boxplot() +  
  geom_point(aes(fill = genotype), size = 2, shape = 21,
             position = position_jitterdodge(jitter.width = 0.4)) + 
  theme_simple() +  
  scale_y_continuous(expand = c(0, 0), limits = c(0, 50)) +
  scale_fill_manual(values = palette)   +
  stat_compare_means(method = "wilcox.test", 
                     label.y = 48,
                     label.x = 1.5,
                     size = 5,
                     label = "p.format") 

collected <- (p1 + p2 + p3) / guide_area() +
  plot_layout(guides = 'collect') +
  plot_annotation(tag_levels = 'A')

collected

ggsave(filename = "first_bioassay_screen.png", plot = collected, width = 10, height = 10)

ggsave(filename = "first_bioassay_screen.svg", plot = collected, width = 10, height = 10)
```

# statistics
```{r wilcoxon}
flies %>%
  group_by(stage) %>%
  wilcox_test(formula = number ~ genotype)
```

```{r wilcoxon effectsize}
flies %>%
  group_by(stage) %>%
  cohens_d(formula = number ~ genotype)
  
```

```{r calculate median eggs}
flies %>%
 dplyr::filter(stage == "egg") %>%
  group_by(genotype) %>%
  summarise(median = median(number))
```

```{r calculate median 4th}
flies %>%
 dplyr::filter(stage == "fourth_instar") %>%
  group_by(genotype) %>%
  summarise(median = median(number))
```

```{r median percentage egg to 4th}
flies %>% 
  pivot_wider(names_from = stage, values_from = number) %>%
  mutate(percentage_from_eggs = fourth_instar / egg * 100) %>%
  pivot_longer(cols = fourth_instar:percentage_from_eggs, 
               names_to = "stage", values_to = "number") %>%
  dplyr::filter(stage == "percentage_from_eggs") %>%
  group_by(genotype) %>%
  summarise(mean = mean(number))
  
```


