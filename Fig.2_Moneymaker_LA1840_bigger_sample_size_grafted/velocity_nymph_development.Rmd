---
title: "Velocity of nymph development"
author: "Lissy Denkers"
date: "`r Sys.Date()`"
output: 
  pdf_document: default
  html_document: default
---


```{r setup, echo=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE, 
                      message = FALSE, 
                      fig.width = 8, 
                      fig.height = 5, 
                      fig.align = "center")
suppressPackageStartupMessages(library("ggplot2"))
suppressPackageStartupMessages(library("ggrepel"))
suppressPackageStartupMessages(library("ggpubr"))
suppressPackageStartupMessages(library("ggpubfigs"))
suppressPackageStartupMessages(library("patchwork"))
suppressPackageStartupMessages(library("plyr"))
suppressPackageStartupMessages(library("dplyr"))
suppressPackageStartupMessages(library("skimr"))
suppressPackageStartupMessages(library("Hmisc"))
suppressPackageStartupMessages(library("tidyr"))
suppressPackageStartupMessages(library("car"))
suppressPackageStartupMessages(library("rstatix"))
suppressPackageStartupMessages(library("tidyverse"))
suppressPackageStartupMessages(library("broom"))
suppressPackageStartupMessages(library("drc"))
suppressPackageStartupMessages(library("modelr"))
suppressPackageStartupMessages(library("egg"))
suppressPackageStartupMessages(library("tidydrc"))
suppressPackageStartupMessages(library("aomisc"))
suppressPackageStartupMessages(library("devtools"))
```

# Data import 

## Background information

As discussed with Huub Hoefsloot and Marc Galland, I will try to calculate the velocity of nymph development per stage. This is the change in number of nymphs per x amount of time. For the amount of time I will start with two days, because I counted once per two days. The calculations are as follows:

\begin{align*}
\Delta 1^{st} & = +1^{st} - +2^{nd} \\
\Delta 2^{nd} & = +2^{nd} - +3^{rd} \\
\Delta 3^{rd} & = +3^{rd} - +4^{th} \\
\Delta 4^{th} & = +4^{th} 
\end{align*}

For more information on the data, see 'data_exploration.pdf'.


## The raw data
```{r flies}
flies <- read.csv("raw_data.csv", 
                         header = T, 
                         sep = ",", 
                         dec = ".", 
                         check.names = FALSE)
# The first 10 rows of the data
knitr::kable(flies[1:10,1:8])
```


```{r filter}
flies <- flies %>%     
  dplyr::filter(place != 4) %>%     
  dplyr::filter(place < 13)
```

```{r wide}
flies <- flies %>%
  mutate(stage = as.factor(stage)) %>%
  pivot_wider(names_from = stage, values_from = number) 
```
 
```{r total fourth instars}
flies <- flies %>%
  mutate(fourth_exuviae = `5_late_fourth_instar` + `6_exuviea`) %>%
  group_by(place) %>%
  mutate(`5_completed_lifecycle` = cumsum(fourth_exuviae)) %>%
  mutate(`6_total_fourth_instars` = `4_early_fourth_instar` + `5_completed_lifecycle`) %>%
  ungroup()
```


# Velocity

I'm wondering if I would get the same result if I do

\begin{align*}
\Delta 1^{st} & = 1^{st}_t - 1^{st}_t-1 \\
\Delta 2^{nd} & = 2^{nd}_t - 2^{nd}_t-1 \\
\Delta 3^{rd} & = 3^{rd}_t - 3^{rd}_t-1 \\
\Delta 4^{th} & = 4^{th}_t - 4^{th}_t-1
\end{align*}

Let's try with the absolute counts.

```{r change per stage per 2 days}
absolute_velocity <- flies %>%
  group_by(place) %>%
  mutate(d_1st = `1_first_instar` - lag(`1_first_instar`))%>%
  mutate(d_2nd = `2_second_instar` - lag(`2_second_instar`))%>%
  mutate(d_3rd = `3_third_instar` - lag(`3_third_instar`))%>%
  mutate(d_4th = `6_total_fourth_instars` - lag(`6_total_fourth_instars`)) %>%
  ungroup()
```

```{r remove unnessesary columns}
absolute_velocity <- absolute_velocity %>%
  dplyr::select(-`0_egg` : -`6_total_fourth_instars`) %>%
  pivot_longer(cols = d_1st:d_4th, 
               names_to = "stage", values_to = "velocity") %>%
  mutate(genotype = factor(genotype, levels = c("MM", "LA1840"))) 
# The first 10 rows of the data
absolute_velocity %>%     
  dplyr::filter(place == 1) %>%     
  dplyr::filter(between(day, 9, 13)) %>%
knitr::kable("pipe", caption = "An example from 1 plant")
```

```{r graph}
palette <- c("#E69F00", "#56B4E9")

absolute_velocity %>%
  dplyr::filter(day > 7) %>% 
  mutate(velocity = na_if(velocity, 0)) %>%
  group_by(genotype, day, stage) %>% 
  ggplot(aes(x=day, y=velocity, group = (interaction (day, genotype)))) + 
  labs(y = "velocity of development",
       x = "days after infection") +
  geom_boxplot(aes(color = genotype)) + 
  scale_color_manual(values = palette) +
  theme_simple() +
  facet_wrap(vars(stage), scales = "free_y")
```
Behind the y-label should be: ($\frac{\Delta instar}{2 days}$), but i don't know how to do that.

I now realize that this just shows the derivative of the counting data and is't much more informative. If the nymphs are stuck in some stage of development the velocity goes to 0, similar to when they have moved on.

I don't know if I did everything right, but I don't think this gives a clearer picture of the development.

For now I  don't know if and how to continue with this.



```{r eval=FALSE, include=FALSE}
# development relative to previous stage

#Another suggestion was to make the data relative to the previous stage.

## cummulative numbers

##This is what happens for the cummulative numbers:

relative_cummulative <- flies %>%
  dplyr::select(-`4_early_fourth_instar`: -`5_completed_lifecycle`)

relative_cummulative <- relative_cummulative %>%
  mutate(first_instars = rowSums(relative_cummulative[,8:11])) %>%
  mutate(second_instars = rowSums(relative_cummulative[,9:11])) %>%
  mutate(third_instars = rowSums(relative_cummulative[,10:11])) %>%
  mutate(fourth_instars = `6_total_fourth_instars`)

relative_cummulative <- relative_cummulative %>%
  group_by(place) %>%
  mutate(first = first_instars / max(eggs_start))%>%
  mutate(second = second_instars / max(first_instars))%>%
  mutate(third = third_instars / max(second_instars))%>%
  mutate(fourth = fourth_instars / max(third_instars)) %>%
  ungroup()

relative_cummulative <- relative_cummulative %>%
  dplyr::select(-eggs_start: -fourth_instars)

relative_cummulative <- relative_cummulative %>%
  pivot_longer(cols = first:fourth, 
               names_to = "stage", values_to = "number") %>%
  mutate(genotype = factor(genotype, levels = c("MM", "LA1840"))) 

p1 <- relative_cummulative %>%
  dplyr::filter(stage == "first") %>% 
  dplyr::filter(day < 15) %>% 
  group_by(genotype) %>% 
  ggplot(aes(x=day, y=number, color = genotype)) +
  labs(y = "first instars",
       x = "days after infection") +
  geom_point() +
  stat_smooth(method = drm, method.args = list(fct = W1.3()), se = FALSE) +
  scale_color_manual(values = palette) +
  theme_simple()

p2 <- relative_cummulative %>%
  dplyr::filter(stage == "second") %>% 
  dplyr::filter(day < 20) %>% 
  group_by(genotype) %>% 
  ggplot(aes(x=day, y=number, color = genotype)) +
  labs(y = "second instars",
       x = "days after infection") +
  geom_point() +
  stat_smooth(method = drm, method.args = list(fct = LL.3()), se = FALSE) +
  scale_color_manual(values = palette) +
  theme_simple()

p3 <- relative_cummulative %>%
  dplyr::filter(stage == "third") %>% 
  group_by(genotype) %>% 
  ggplot(aes(x=day, y=number, color = genotype)) +
  labs(y = "third instars",
       x = "days after infection") +
  geom_point() +
  stat_smooth(method = drm, method.args = list(fct = LL.3()), se = FALSE) +
  scale_color_manual(values = palette) +
  theme_simple()

p4 <- relative_cummulative %>%
  dplyr::filter(stage == "fourth") %>% 
  group_by(genotype) %>% 
  ggplot(aes(x=day, y=number, color = genotype)) + 
  labs(y = "fourth instars",
       x = "days after infection") +
  geom_point() +
  stat_smooth(method = drm, method.args = list(fct = LL.3()), se = FALSE) +  
  scale_color_manual(values = palette) +
  theme_simple()

(p1 + p2) / (p3 + p4)  / guide_area() +
  plot_layout(guides = 'collect')
```



```{r eval=FALSE, include=FALSE}

## per count numbers

##This is what happens for the non-cummulative numbers:

relative_flies <- flies %>%
  dplyr::select(-`4_early_fourth_instar`: -`5_completed_lifecycle`)

relative_flies <- relative_flies %>%
  mutate(first_instars = rowSums(relative_flies[,8:11])) %>%
  mutate(second_instars = rowSums(relative_flies[,9:11])) %>%
  mutate(third_instars = rowSums(relative_flies[,10:11])) %>%
  mutate(fourth_instars = `6_total_fourth_instars`)

relative_flies <- relative_flies %>%
  group_by(place) %>%
  mutate(first = `1_first_instar` / max(eggs_start))%>%
  mutate(second = `2_second_instar` / max(first_instars))%>%
  mutate(third = `3_third_instar` / max(second_instars))%>%
  mutate(fourth = fourth_instars / max(third_instars)) %>%
  ungroup()

relative_flies <- relative_flies %>%
  dplyr::select(-eggs_start: -fourth_instars)

relative_flies <- relative_flies %>%
  pivot_longer(cols = first:fourth, 
               names_to = "stage", values_to = "number") %>%
  mutate(genotype = factor(genotype, levels = c("MM", "LA1840"))) 

p5 <- relative_flies %>%
  dplyr::filter(stage == "first") %>% 
  #dplyr::filter(day < 15) %>% 
  group_by(genotype, day) %>% 
  ggplot(aes(x=day, y=number, group = (interaction (day, genotype)))) + 
  labs(y = "first instars",
       x = "days after infection") +
  geom_boxplot(aes(color = genotype)) + 
  scale_color_manual(values = palette) +
  theme_simple()

p6 <- relative_flies %>%
  dplyr::filter(stage == "second") %>% 
  #dplyr::filter(day < 20) %>% 
  group_by(genotype, day) %>% 
  ggplot(aes(x=day, y=number, group = (interaction (day, genotype)))) + 
  labs(y = "second instars",
       x = "days after infection") +
  geom_point(aes(color = genotype)) + 
  geom_smooth(method = 'loess', formula = 'y~poly(x)', aes(color = genotype)) +
  scale_color_manual(values = palette) +
  theme_simple()


fit1 <- relative_flies %>%
  dplyr::filter(stage == "third") %>% 
  #dplyr::filter(place == 1) %>% 
  dplyr::filter(genotype == "LA1840") %>%
  mutate(x = day) %>%
  mutate(y = number)
fit <- nls(y ~ SSlogis5(x, asym1, asym2, xmid, iscal, theta), data = fit1)

ggplot(data = fit1, aes(x = day, y = number, color = genotype)) +
geom_point() +
geom_smooth(aes(y = fitted(fit)))

p7 <- relative_flies %>%
  dplyr::filter(stage == "third") %>% 
  #dplyr::filter(day > 11) %>% 
  group_by(genotype) %>% 
  ggplot(aes(x=day, y=number, 
             color = genotype, fill = genotype)) + 
  labs(y = "third instars",
       x = "days after infection") +
  #ylim(0,1)+
  geom_point()  + 
  #geom_line(aes(y = fitted(fit), color = genotype)) +
   geom_smooth(aes(x = day,
                y = number, color = genotype), method = "glm", method.args = list(family = "binomial"), formula = y ~ splines2::bSpline(x), se = TRUE) +
  scale_color_manual(values = palette) +
  theme_simple()

p7 + 
  geom_line(aes(y = fitted(fit), color = genotype))

 p8 <- relative_flies %>%
  dplyr::filter(stage == "fourth") %>% 
  group_by(genotype) %>% 
  ggplot(aes(x=day, y=number, 
             color = genotype)) + 
  labs(y = "fourth instars",
       x = "days after infection") +
  geom_point() +
  stat_smooth(method = drm, method.args = list(fct = LL.3()), se = FALSE) + 
  scale_color_manual(values = palette) +
  theme_simple()

#, group = (interaction (day, genotype))

(p1 + p2) / (p3 + p4)  / guide_area() +
  plot_layout(guides = 'collect')
```



```{r eval=FALSE, include=FALSE}
### first instars
fit1 <- relative_cummulative %>%
  dplyr::filter(stage == "first") %>% 
  dplyr::filter(genotype == "LA1840") %>%
  mutate(x = day) %>%
  mutate(y = number)
```

```{r eval=FALSE, include=FALSE}
model.au.cases <- fit1$number
model.au.day <- fit1$day
model.au.richards <- drm(model.au.cases ~ model.au.day, fct = L.5())
model.au.summary <- summary(model.au.richards)
```
```{r eval=FALSE, include=FALSE}
prediction_days <- data.frame(model.au.day )
model.au.pred <- data.frame(predict(model.au.richards, newdata = prediction_days, interval = 'prediction'))
model.au.predCI <- data.frame(predict(model.au.richards, newdata = prediction_days, interval = 'confidence'))
```
```{r eval=FALSE, include=FALSE}
model.au <- data.frame(day = prediction_days, fit = model.au.pred$Prediction, lwr = model.au.pred$Lower, upr = model.au.pred$Upper)
model.auCI <- data.frame(day = prediction_days, fit = model.au.predCI$Prediction, lwr = model.au.predCI$Lower, upr = model.au.predCI$Upper)

# Replace any predicted values < 0 to be equal to zero.
# Obviously, there can't be less than 0 cases.
model.au$lwr[model.au$lwr < 0] <- 0
model.auCI$lwr[model.auCI$lwr < 0] <- 0
```
```{r eval=FALSE, include=FALSE}
model.au.fit.fn <- splinefun(model.au.day, model.au$fit)
model.au.fit.deriv <- model.au.fit.fn(model.au.day, deriv = 1)
model.au.fit.deriv[model.au.fit.deriv < 0] <- 0

model.au.upr.deriv <- model.au.fit.deriv + (model.au$upr - model.au$fit)
model.au.lwr.deriv <- model.au.fit.deriv - (model.au$fit - model.au$lwr)
model.au.lwr.deriv[model.au.lwr.deriv < 0] <- 0
```
```{r eval=FALSE, include=FALSE}
model.auCI.fit.fn <- splinefun(model.au.day, model.auCI$fit)
model.auCI.fit.deriv <- model.auCI.fit.fn(model.au.day, deriv = 1)
model.auCI.fit.deriv[model.auCI.fit.deriv < 0] <- 0

model.auCI.upr.deriv <- model.auCI.fit.deriv + (model.auCI$upr - model.auCI$fit)
model.auCI.lwr.deriv <- model.auCI.fit.deriv - (model.auCI$fit - model.auCI$lwr)
model.auCI.lwr.deriv[model.auCI.lwr.deriv < 0] <- 0
```
```{r eval=FALSE, include=FALSE}
LA1840_first <- ggplot(data=fit1, aes(x=day, y=number)) +  
	geom_ribbon(aes(ymin=model.auCI.lwr.deriv, ymax=model.auCI.upr.deriv), fill="#56B4E9", colour=NA, alpha=0.1) +
    geom_line(aes(y=model.au.fit.deriv), colour="#56B4E9", size = 1, linetype=1)  +
  theme_simple()
  
```


```{r eval=FALSE, include=FALSE}
fit2 <- relative_cummulative %>%
  dplyr::filter(stage == "first") %>% 
  dplyr::filter(genotype == "MM") %>%
  mutate(x = day) %>%
  mutate(y = number)
```

```{r eval=FALSE, include=FALSE}
model.mm.cases <- fit2$number
model.mm.day <- fit2$day
model.mm.richards <- drm(model.mm.cases ~ model.mm.day, fct = L.5())
model.mm.summary <- summary(model.mm.richards)
```
```{r eval=FALSE, include=FALSE}
prediction_days <- data.frame(model.mm.day )
model.mm.pred <- data.frame(predict(model.mm.richards, newdata = prediction_days, interval = 'prediction'))
model.mm.predCI <- data.frame(predict(model.mm.richards, newdata = prediction_days, interval = 'confidence'))
```
```{r eval=FALSE, include=FALSE}
model.mm <- data.frame(day = prediction_days, fit = model.mm.pred$Prediction, lwr = model.mm.pred$Lower, upr = model.mm.pred$Upper)
model.mmCI <- data.frame(day = prediction_days, fit = model.mm.predCI$Prediction, lwr = model.mm.predCI$Lower, upr = model.mm.predCI$Upper)
```
```{r eval=FALSE, include=FALSE}
# Replace any predicted values < 0 to be equal to zero.
# Obviously, there can't be less than 0 cases.
model.mm$lwr[model.mm$lwr < 0] <- 0
model.mmCI$lwr[model.mmCI$lwr < 0] <- 0
```

```{r eval=FALSE, include=FALSE}
model.mm.fit.fn <- splinefun(model.mm.day, model.mm$fit)
model.mm.fit.deriv <- model.mm.fit.fn(model.mm.day, deriv = 1)
model.mm.fit.deriv[model.mm.fit.deriv < 0] <- 0

model.mm.upr.deriv <- model.mm.fit.deriv + (model.mm$upr - model.mm$fit)
model.mm.lwr.deriv <- model.mm.fit.deriv - (model.mm$fit - model.mm$lwr)
model.mm.lwr.deriv[model.mm.lwr.deriv < 0] <- 0
```
```{r eval=FALSE, include=FALSE}
model.mmCI.fit.fn <- splinefun(model.mm.day, model.mmCI$fit)
model.mmCI.fit.deriv <- model.mmCI.fit.fn(model.mm.day, deriv = 1)
model.mmCI.fit.deriv[model.mmCI.fit.deriv < 0] <- 0

model.mmCI.upr.deriv <- model.mmCI.fit.deriv + (model.mmCI$upr - model.mmCI$fit)
model.mmCI.lwr.deriv <- model.mmCI.fit.deriv - (model.mmCI$fit - model.mmCI$lwr)
model.mmCI.lwr.deriv[model.mmCI.lwr.deriv < 0] <- 0
```
```{r eval=FALSE, include=FALSE}
MM_first <-
  ggplot(data=fit2, aes(x=day, y=number)) +  
	geom_ribbon(aes(ymin=model.mmCI.lwr.deriv, ymax=model.mmCI.upr.deriv), fill="#E69F00", colour=NA, alpha=0.1) +
    geom_line(aes(y=model.mm.fit.deriv), colour="#E69F00", size = 1, linetype=1)  +
  theme_simple()
```

```{r eval=FALSE, include=FALSE}

MM_first + LA1840_first

```



```{r eval=FALSE, include=FALSE}
### second instars
fit1 <- relative_cummulative %>%
  dplyr::filter(stage == "second") %>% 
  #dplyr::filter(place == 1) %>% 
  dplyr::filter(genotype == "LA1840") %>%
  mutate(x = day) %>%
  mutate(y = number)
```

```{r eval=FALSE, include=FALSE}
model.au.cases <- fit1$number
model.au.day <- fit1$day
model.au.richards <- drm(model.au.cases ~ model.au.day, fct = L.5())
model.au.summary <- summary(model.au.richards)
```
```{r eval=FALSE, include=FALSE}
prediction_days <- data.frame(model.au.day )
model.au.pred <- data.frame(predict(model.au.richards, newdata = prediction_days, interval = 'prediction'))
model.au.predCI <- data.frame(predict(model.au.richards, newdata = prediction_days, interval = 'confidence'))
```
```{r eval=FALSE, include=FALSE}
model.au <- data.frame(day = prediction_days, fit = model.au.pred$Prediction, lwr = model.au.pred$Lower, upr = model.au.pred$Upper)
model.auCI <- data.frame(day = prediction_days, fit = model.au.predCI$Prediction, lwr = model.au.predCI$Lower, upr = model.au.predCI$Upper)

# Replace any predicted values < 0 to be equal to zero.
# Obviously, there can't be less than 0 cases.
model.au$lwr[model.au$lwr < 0] <- 0
model.auCI$lwr[model.auCI$lwr < 0] <- 0
```
```{r eval=FALSE, include=FALSE}
model.au.fit.fn <- splinefun(model.au.day, model.au$fit)
model.au.fit.deriv <- model.au.fit.fn(model.au.day, deriv = 1)
model.au.fit.deriv[model.au.fit.deriv < 0] <- 0

model.au.upr.deriv <- model.au.fit.deriv + (model.au$upr - model.au$fit)
model.au.lwr.deriv <- model.au.fit.deriv - (model.au$fit - model.au$lwr)
model.au.lwr.deriv[model.au.lwr.deriv < 0] <- 0
```
```{r eval=FALSE, include=FALSE}
model.auCI.fit.fn <- splinefun(model.au.day, model.auCI$fit)
model.auCI.fit.deriv <- model.auCI.fit.fn(model.au.day, deriv = 1)
model.auCI.fit.deriv[model.auCI.fit.deriv < 0] <- 0

model.auCI.upr.deriv <- model.auCI.fit.deriv + (model.auCI$upr - model.auCI$fit)
model.auCI.lwr.deriv <- model.auCI.fit.deriv - (model.auCI$fit - model.auCI$lwr)
model.auCI.lwr.deriv[model.auCI.lwr.deriv < 0] <- 0
```
```{r eval=FALSE, include=FALSE}
LA1840_second <- ggplot(data=fit1, aes(x=day, y=number)) +  
	geom_ribbon(aes(ymin=model.auCI.lwr.deriv, ymax=model.auCI.upr.deriv), fill="#56B4E9", colour=NA, alpha=0.1) +
    geom_line(aes(y=model.au.fit.deriv), colour="#56B4E9", size = 1, linetype=1)  +
  theme_simple()
  
```


```{r eval=FALSE, include=FALSE}
fit2 <- relative_cummulative %>%
  dplyr::filter(stage == "second") %>% 
  #dplyr::filter(place == 1) %>% 
  dplyr::filter(genotype == "MM") %>%
  mutate(x = day) %>%
  mutate(y = number)
```

```{r eval=FALSE, include=FALSE}
model.mm.cases <- fit2$number
model.mm.day <- fit2$day
model.mm.richards <- drm(model.mm.cases ~ model.mm.day, fct = L.5())
model.mm.summary <- summary(model.mm.richards)
```
```{r eval=FALSE, include=FALSE}
prediction_days <- data.frame(model.mm.day )
model.mm.pred <- data.frame(predict(model.mm.richards, newdata = prediction_days, interval = 'prediction'))
model.mm.predCI <- data.frame(predict(model.mm.richards, newdata = prediction_days, interval = 'confidence'))
```
```{r eval=FALSE, include=FALSE}
model.mm <- data.frame(day = prediction_days, fit = model.mm.pred$Prediction, lwr = model.mm.pred$Lower, upr = model.mm.pred$Upper)
model.mmCI <- data.frame(day = prediction_days, fit = model.mm.predCI$Prediction, lwr = model.mm.predCI$Lower, upr = model.mm.predCI$Upper)
```
```{r eval=FALSE, include=FALSE}
# Replace any predicted values < 0 to be equal to zero.
# Obviously, there can't be less than 0 cases.
model.mm$lwr[model.mm$lwr < 0] <- 0
model.mmCI$lwr[model.mmCI$lwr < 0] <- 0
```

```{r eval=FALSE, include=FALSE}
model.mm.fit.fn <- splinefun(model.mm.day, model.mm$fit)
model.mm.fit.deriv <- model.mm.fit.fn(model.mm.day, deriv = 1)
model.mm.fit.deriv[model.mm.fit.deriv < 0] <- 0

model.mm.upr.deriv <- model.mm.fit.deriv + (model.mm$upr - model.mm$fit)
model.mm.lwr.deriv <- model.mm.fit.deriv - (model.mm$fit - model.mm$lwr)
model.mm.lwr.deriv[model.mm.lwr.deriv < 0] <- 0
```
```{r eval=FALSE, include=FALSE}
model.mmCI.fit.fn <- splinefun(model.mm.day, model.mmCI$fit)
model.mmCI.fit.deriv <- model.mmCI.fit.fn(model.mm.day, deriv = 1)
model.mmCI.fit.deriv[model.mmCI.fit.deriv < 0] <- 0

model.mmCI.upr.deriv <- model.mmCI.fit.deriv + (model.mmCI$upr - model.mmCI$fit)
model.mmCI.lwr.deriv <- model.mmCI.fit.deriv - (model.mmCI$fit - model.mmCI$lwr)
model.mmCI.lwr.deriv[model.mmCI.lwr.deriv < 0] <- 0
```
```{r eval=FALSE, include=FALSE}
MM_second <-
  ggplot(data=fit2, aes(x=day, y=number)) +  
	geom_ribbon(aes(ymin=model.mmCI.lwr.deriv, ymax=model.mmCI.upr.deriv), fill="#E69F00", colour=NA, alpha=0.1) +
    geom_line(aes(y=model.mm.fit.deriv), colour="#E69F00", size = 1, linetype=1)  +
  theme_simple()
```

```{r eval=FALSE, include=FALSE}

MM_second + LA1840_second

```



```{r eval=FALSE, include=FALSE}
### third instars
fit1 <- relative_cummulative %>%
  dplyr::filter(stage == "third") %>% 
  #dplyr::filter(place == 1) %>% 
  dplyr::filter(genotype == "LA1840") %>%
  mutate(x = day) %>%
  mutate(y = number)
```

```{r eval=FALSE, include=FALSE}
model.au.cases <- fit1$number
model.au.day <- fit1$day
model.au.richards <- drm(model.au.cases ~ model.au.day, fct = L.5())
model.au.summary <- summary(model.au.richards)
```
```{r eval=FALSE, include=FALSE}
prediction_days <- data.frame(model.au.day )
model.au.pred <- data.frame(predict(model.au.richards, newdata = prediction_days, interval = 'prediction'))
model.au.predCI <- data.frame(predict(model.au.richards, newdata = prediction_days, interval = 'confidence'))
```
```{r eval=FALSE, include=FALSE}
model.au <- data.frame(day = prediction_days, fit = model.au.pred$Prediction, lwr = model.au.pred$Lower, upr = model.au.pred$Upper)
model.auCI <- data.frame(day = prediction_days, fit = model.au.predCI$Prediction, lwr = model.au.predCI$Lower, upr = model.au.predCI$Upper)

# Replace any predicted values < 0 to be equal to zero.
# Obviously, there can't be less than 0 cases.
model.au$lwr[model.au$lwr < 0] <- 0
model.auCI$lwr[model.auCI$lwr < 0] <- 0
```
```{r eval=FALSE, include=FALSE}
model.au.fit.fn <- splinefun(model.au.day, model.au$fit)
model.au.fit.deriv <- model.au.fit.fn(model.au.day, deriv = 1)
model.au.fit.deriv[model.au.fit.deriv < 0] <- 0

model.au.upr.deriv <- model.au.fit.deriv + (model.au$upr - model.au$fit)
model.au.lwr.deriv <- model.au.fit.deriv - (model.au$fit - model.au$lwr)
model.au.lwr.deriv[model.au.lwr.deriv < 0] <- 0
```
```{r eval=FALSE, include=FALSE}
model.auCI.fit.fn <- splinefun(model.au.day, model.auCI$fit)
model.auCI.fit.deriv <- model.auCI.fit.fn(model.au.day, deriv = 1)
model.auCI.fit.deriv[model.auCI.fit.deriv < 0] <- 0

model.auCI.upr.deriv <- model.auCI.fit.deriv + (model.auCI$upr - model.auCI$fit)
model.auCI.lwr.deriv <- model.auCI.fit.deriv - (model.auCI$fit - model.auCI$lwr)
model.auCI.lwr.deriv[model.auCI.lwr.deriv < 0] <- 0
```
```{r eval=FALSE, include=FALSE}
LA1840_third <- ggplot(data=fit1, aes(x=day, y=number)) +  
	geom_ribbon(aes(ymin=model.auCI.lwr.deriv, ymax=model.auCI.upr.deriv), fill="#56B4E9", colour=NA, alpha=0.1) +
    geom_line(aes(y=model.au.fit.deriv), colour="#56B4E9", size = 1, linetype=1)  +
  theme_simple()
  
```


```{r eval=FALSE, include=FALSE}
fit2 <- relative_cummulative %>%
  dplyr::filter(stage == "third") %>% 
  #dplyr::filter(place == 1) %>% 
  dplyr::filter(genotype == "MM") %>%
  mutate(x = day) %>%
  mutate(y = number)
```

```{r eval=FALSE, include=FALSE}
model.mm.cases <- fit2$number
model.mm.day <- fit2$day
model.mm.richards <- drm(model.mm.cases ~ model.mm.day, fct = L.5())
model.mm.summary <- summary(model.mm.richards)
```
```{r eval=FALSE, include=FALSE}
prediction_days <- data.frame(model.mm.day )
model.mm.pred <- data.frame(predict(model.mm.richards, newdata = prediction_days, interval = 'prediction'))
model.mm.predCI <- data.frame(predict(model.mm.richards, newdata = prediction_days, interval = 'confidence'))
```
```{r eval=FALSE, include=FALSE}
model.mm <- data.frame(day = prediction_days, fit = model.mm.pred$Prediction, lwr = model.mm.pred$Lower, upr = model.mm.pred$Upper)
model.mmCI <- data.frame(day = prediction_days, fit = model.mm.predCI$Prediction, lwr = model.mm.predCI$Lower, upr = model.mm.predCI$Upper)
```
```{r eval=FALSE, include=FALSE}
# Replace any predicted values < 0 to be equal to zero.
# Obviously, there can't be less than 0 cases.
model.mm$lwr[model.mm$lwr < 0] <- 0
model.mmCI$lwr[model.mmCI$lwr < 0] <- 0
```

```{r eval=FALSE, include=FALSE}
model.mm.fit.fn <- splinefun(model.mm.day, model.mm$fit)
model.mm.fit.deriv <- model.mm.fit.fn(model.mm.day, deriv = 1)
model.mm.fit.deriv[model.mm.fit.deriv < 0] <- 0

model.mm.upr.deriv <- model.mm.fit.deriv + (model.mm$upr - model.mm$fit)
model.mm.lwr.deriv <- model.mm.fit.deriv - (model.mm$fit - model.mm$lwr)
model.mm.lwr.deriv[model.mm.lwr.deriv < 0] <- 0
```
```{r eval=FALSE, include=FALSE}
model.mmCI.fit.fn <- splinefun(model.mm.day, model.mmCI$fit)
model.mmCI.fit.deriv <- model.mmCI.fit.fn(model.mm.day, deriv = 1)
model.mmCI.fit.deriv[model.mmCI.fit.deriv < 0] <- 0

model.mmCI.upr.deriv <- model.mmCI.fit.deriv + (model.mmCI$upr - model.mmCI$fit)
model.mmCI.lwr.deriv <- model.mmCI.fit.deriv - (model.mmCI$fit - model.mmCI$lwr)
model.mmCI.lwr.deriv[model.mmCI.lwr.deriv < 0] <- 0
```
```{r eval=FALSE, include=FALSE}
MM_third <-
  ggplot(data=fit2, aes(x=day, y=number)) +  
	geom_ribbon(aes(ymin=model.mmCI.lwr.deriv, ymax=model.mmCI.upr.deriv), fill="#E69F00", colour=NA, alpha=0.1) +
    geom_line(aes(y=model.mm.fit.deriv), colour="#E69F00", size = 1, linetype=1)  +
  theme_simple()
```

```{r eval=FALSE, include=FALSE}

MM_third + LA1840_third

```
  
